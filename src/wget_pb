local config = require("cfg/wget_pb")

local argv = {...}
local argc = #argv

function parse_flags(flags)
	local result = {}

	print("Flags", flags)

	for index, value in ipairs(flags) do
		local firstCharacter = string.sub(flags, 1, 1)
		print("fst char: ", firstCharacter)

		if firstCharacter == "-" then
			for i = 2, #value do
				local c = string.sub(value, i, i)
				print("c: ", c)
				table.insert(result, c)
			end
		else
			error("Invalid argument!")
		end
	end

	print("Result: ", result)
	return result
end

function install_url(url, identifier)
	local success = shell.run("pastebin", "get", url, identifier)
	if success == false then error("Failed to install program!") end
end

function install(data)
	local url        = data.url
	local identifier = data.identifier
	local config     = data.config
	local success    = false

	if url        == "" then error("URL may not be empty!")        end
	if identifier == "" then error("Identifier may not be empty!") end
	
	install_url(url, identifier)
	for index, value in ipairs(config) do
		install_url(value.url, "cfg/" + value.identifier)
	end
end

function main()
	term.clear()
	term.setCursorPos(1, 1)

	local flags = parse_flags(argv)

	for index, value in ipairs(flags) do
		if value == "r" then
			local required = config.required

			for index, value in ipairs(required) do
				install(value)
			end
		end
		if value == "o" then
			local optional = config.optional

			for index, value in ipairs(optional) do
				install(value)
			end
		end
	end
	
end

main()




--functions
function InstallOptinal(name, PastebinLink)
	print("Do you want to install: "..name.."?")
	print("type y to install")
	local reply = read()
	if reply == "y" then
		InstallReq(name, PastebinLink)
	end
end

function InstallReq (name, PastebinLink)
	if has_value (programs, name) then
		print(name.." Is already Installed, deleting and reinstalling")
		shell.run("delete", name)
	end
	shell.run("pastebin", "get", PastebinLink, name)
	print("\n")
end

function SetupStartup()
	if fs.exists("startup") then
		shell.run("delete", "startup")
	end
	startup = fs.open("startup", "w")
	startup.writeLine("shell.run(\"KomOS\")")
	startup.close()
end

function has_value (tab, val)
    for index, value in ipairs(tab) do
        if value == val then
            return true
        end
    end

    return false
end

function InstallAllReq()
    --Install utils
	InstallReq("u_Utils", "1ER4YDVy")
	InstallReq("u_Sprite", "ch2vDQmA")
	InstallReq("u_Config", "CRM2JH0S")
	InstallReq("u_Area", "NFn54B08")

	--OS
	InstallReq("KomOS", "byxjwqMv")

	--programs
	InstallReq("p_Refuel", "3Gq09d8G")
	
	--Create startup
	SetupStartup()
end

--Start
term.clear()
term.setCursorPos(1, 1)

function InstallOptions()
    InstallOptinal("p_TreeFarmer", "3TPy8Ewx")
	InstallOptinal("p_Miner", "PV36b31K")
	InstallOptinal("p_Farm", "7y2RqRmA")
end

--Instal requireds (update system)
if OptionOnly == false then
	InstallAllReq()
end

--Instal optionals (setup system)
if ReqOnly == false then
	InstallOptions()
end

--finish
term.clear()
term.setCursorPos(1, 1)
print("\nInstallation finished\nStarting KomOS")
sleep(1)
shell.run("KomOS")
